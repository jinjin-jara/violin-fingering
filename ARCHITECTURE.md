# 🏗️ 아키텍처 문서

## 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────┐
│                    사용자 인터페이스                      │
│  (FileUpload, ScorePreview, LoadingSpinner)            │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  페이지 레이어 (Next.js)                  │
│  (index.tsx - 메인 페이지, 상태 관리)                    │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  비즈니스 로직 레이어                     │
│  ┌──────────────────┐  ┌──────────────────┐              │
│  │  scoreParser.ts │  │ keyDetection.ts │              │
│  │  (악보 파싱)     │  │  (조성 판별)     │              │
│  └────────┬─────────┘  └────────┬─────────┘              │
│           │                      │                         │
│           └──────────┬───────────┘                         │
│                      ▼                                     │
│           ┌──────────────────────┐                        │
│           │ fingeringCalculator  │                        │
│           │    (운지 계산)        │                        │
│           └──────────────────────┘                        │
└─────────────────────────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│                  데이터 레이어                            │
│  (타입 정의: types/music.ts)                             │
└─────────────────────────────────────────────────────────┘
```

## 핵심 모듈 상세

### 1. scoreParser.ts

**역할**: 악보 파일(이미지/PDF)을 파싱하여 음표 데이터 추출

**주요 함수:**
- `extractKeySignature()`: 조표 추출
- `extractNotes()`: 음표 추출
- `extractFromPDF()`: PDF 처리
- `analyzeScore()`: 전체 분석 파이프라인

**현재 상태**: 기본 구조만 구현 (TODO 주석 표시)
**개선 필요**: 실제 OCR/ML 모델 통합

### 2. keyDetection.ts

**역할**: 조표를 기반으로 조성 판별 및 실제 음표 계산

**주요 함수:**
- `detectKeyFromSignature()`: 조표 → 조성 변환
- `getActualNote()`: 조성 반영 실제 음표 계산
- `normalizeNoteName()`: 음표 이름 표준화

**핵심 로직:**
```typescript
// 조표 샤프 개수에 따른 조성 매핑
0 샤프 → C major / A minor
1 샤프 → G major / E minor
2 샤프 → D major / B minor
...
```

### 3. fingeringCalculator.ts

**역할**: 음표를 바이올린 지판 위치로 변환

**주요 함수:**
- `calculateFingering()`: 단일 음표 운지 계산
- `calculateFingerings()`: 여러 음표 일괄 계산
- `calculateFingeringOnString()`: 특정 현에서 운지 계산

**핵심 알고리즘:**

1. **절대 반음 수 계산**
   ```
   음표 → 반음 단위 변환 (C=0, C#=1, D=2, ...)
   옥타브 × 12 + 반음 수 = 절대 반음 수
   ```

2. **현별 연주 가능 여부 확인**
   ```
   개방현 음의 절대 반음 수 계산
   최대 연주 범위 = 개방현 + 포지션 오프셋 + 손가락 4번
   ```

3. **최적 운지 선택**
   - 우선순위: 낮은 현 > 낮은 포지션 > 낮은 손가락

## 데이터 모델

### Note (음표)
```typescript
{
  name: "G",        // 음표 이름
  octave: 4,        // 옥타브
  x: 100,           // 악보상 x 좌표
  y: 200,           // 악보상 y 좌표
  duration: 1       // 음표 길이
}
```

### Fingering (운지)
```typescript
{
  string: "A",      // 현 (E/A/D/G)
  finger: 2,        // 손가락 번호 (0-4)
  position: "1st",  // 포지션
  note: Note        // 원본 음표
}
```

### KeyInfo (조성 정보)
```typescript
{
  key: "A",         // 조성
  mode: "major",    // 장조/단조
  sharps: 3,        // 샤프 개수
  flats: 0          // 플랫 개수
}
```

## 악보 분석 파이프라인

```
1. 파일 업로드
   ↓
2. 파일 타입 확인 (이미지/PDF)
   ↓
3. 이미지로 변환 (PDF인 경우)
   ↓
4. 조표 추출
   ├─→ detectKeyFromSignature()
   └─→ KeyInfo 생성
   ↓
5. 음표 추출
   ├─→ 각 음표의 name, octave, x, y 추출
   └─→ Note[] 배열 생성
   ↓
6. 조성 반영
   ├─→ getActualNote()로 각 음표의 실제 음 계산
   └─→ 조표에 따른 샤프/플랫 적용
   ↓
7. 운지 계산
   ├─→ calculateFingering()로 각 음표 처리
   └─→ Fingering[] 배열 생성
   ↓
8. 결과 렌더링
   ├─→ 원본 악보 이미지 로드
   ├─→ Canvas에 원본 그리기
   └─→ 운지 숫자 오버레이
   ↓
9. 저장 (PNG/PDF)
```

## PWA 구조

### Service Worker (sw.js)

**캐싱 전략:**
- Install: 기본 파일 캐싱
- Fetch: 캐시 우선, 없으면 네트워크
- Activate: 오래된 캐시 삭제

**오프라인 지원:**
- 기본 HTML/CSS/JS 캐싱
- 이미지/PDF는 동적 캐싱

### Manifest (manifest.json)

- 앱 이름, 아이콘, 테마 색상 정의
- 홈 화면 설치 가능

## 성능 고려사항

### 최적화 포인트

1. **이미지 처리**
   - 대용량 이미지 리사이징
   - Canvas 최적화

2. **계산 최적화**
   - Web Worker를 통한 백그라운드 처리
   - 운지 계산 결과 캐싱

3. **번들 크기**
   - 코드 스플리팅
   - 동적 import 사용

## 확장 가능성

### 향후 추가 가능한 기능

1. **다중 포지션 지원**
   - 사용자가 포지션 선택
   - 여러 운지 옵션 제시

2. **악보 편집**
   - 운지 수동 수정
   - 음표 추가/삭제

3. **다른 악기 지원**
   - 비올라, 첼로 등
   - 각 악기별 지판 매핑

4. **실시간 연주**
   - MIDI 연동
   - 운지 하이라이트
